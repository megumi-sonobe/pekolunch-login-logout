{% extends 'base.html' %}

{% block title %}
    レシピ一覧 - peko Lunch
{% endblock %}

{% block content %}
<div class="content-container">
    <div class="main-content">
        <h2>レシピ一覧</h2>

        {% if not recipes %}
            <p>該当するレシピは見つかりませんでした。</p>
            <p>もう一度検索してください。</p>
            <a href="{% url 'recipes:recipe_list' %}">料理一覧に戻る</a>
        {% else %}
            <div class="recipe-grid">
                {% for recipe in recipes %}
                    <div class="recipe-item">
                        <a href="{% url 'recipes:recipe_detail' recipe.pk %}">
                            {% if recipe.image_url %}
                                <img src="{{ recipe.image_url.url }}" alt="{{ recipe.recipe_name }}" width="150" height="150">
                            {% else %}
                                <img src="{{ MEDIA_URL }}default_recipe_image.jpg" alt="デフォルト画像" width="150" height="150">
                            {% endif %}
                            <p>{{ recipe.recipe_name }}</p>
                        </a>
                        <p>平均評価：{{ recipe.average_evaluation|default:"評価なし" }}</p>
                        {% if request.GET.from_edit_meal_plan %}
                            <button onclick="selectRecipe('{{ recipe.id }}', '{{ request.GET.date }}', '{{ request.GET.meal_type }}')">このレシピを選択</button>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- ページネーションリンクの追加 -->
        <div class="pagination">
            <span class="step-links">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.from_edit_meal_plan %}&from_edit_meal_plan={{ request.GET.from_edit_meal_plan }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.meal_type %}&meal_type={{ request.GET.meal_type }}{% endif %}">&laquo; 最初</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.from_edit_meal_plan %}&from_edit_meal_plan={{ request.GET.from_edit_meal_plan }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.meal_type %}&meal_type={{ request.GET.meal_type }}{% endif %}">前へ</a>
                {% endif %}

                <span class="current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.from_edit_meal_plan %}&from_edit_meal_plan={{ request.GET.from_edit_meal_plan }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.meal_type %}&meal_type={{ request.GET.meal_type }}{% endif %}">次へ</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.from_edit_meal_plan %}&from_edit_meal_plan={{ request.GET.from_edit_meal_plan }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.meal_type %}&meal_type={{ request.GET.meal_type }}{% endif %}">最後 &raquo;</a>
                {% endif %}
            </span>
        </div>
        <!-- ここまでがページネーションリンクの追加部分 -->
    </div>

    <div class="sidebar">
        <form method="GET" action="{% url 'recipes:search' %}">
            <input type="text" name="q" placeholder="料理名で検索" value="{{ request.GET.q }}">
            <input type="hidden" name="from_edit_meal_plan" value="{{ request.GET.from_edit_meal_plan }}">
            <input type="hidden" name="date" value="{{ request.GET.date }}">
            <input type="hidden" name="meal_type" value="{{ request.GET.meal_type }}">
            <button type="submit" class="search-button">検索</button>
            <br><br>
                
            <h4>条件検索</h4>
            <div>
                <input type="checkbox" id="my_recipe" name="filter" value="my_recipe" {% if 'my_recipe' in request.GET.filter %}checked{% endif %}>
                <label for="my_recipe">マイレシピ</label>
            </div>
            <div>
                <input type="checkbox" id="three_star" name="filter" value="three_star" {% if 'three_star' in request.GET.filter %}checked{% endif %}>
                <label for="three_star">三つ星レシピ</label>
            </div>
            <div>
                <input type="checkbox" id="main_dish" name="filter" value="main_dish" {% if 'main_dish' in request.GET.filter %}checked{% endif %}>
                <label for="main_dish">主食</label>
            </div>
            <div>
                <input type="checkbox" id="side_dish" name="filter" value="side_dish" {% if 'side_dish' in request.GET.filter %}checked{% endif %}>
                <label for="side_dish">主菜</label>
            </div>
            <div>
                <input type="checkbox" id="sub_dish" name="filter" value="sub_dish" {% if 'sub_dish' in request.GET.filter %}checked{% endif %}>
                <label for="sub_dish">副菜</label>
            </div>
            <div>
                <input type="checkbox" id="soup" name="filter" value="soup" {% if 'soup' in request.GET.filter %}checked{% endif %}>
                <label for="soup">汁物</label>
            </div>

            <button type="submit" class="search-button">検索</button>
        </form>
    </div>
</div>

<script>
function parseDateString(dateString) {
    const dateParts = dateString.split('（')[0].split('/');
    const month = parseInt(dateParts[0], 10) - 1; // 月は0から始まるので -1 する
    const day = parseInt(dateParts[1], 10);
    const year = new Date().getFullYear(); // 現在の年を取得
    return new Date(year, month, day);
}

function selectRecipe(recipeId, date, mealType) {
    const parsedDate = parseDateString(date);

    // ローカルタイムで日付をフォーマット
    const formattedDate = parsedDate.getFullYear() + '-' +
                          ('0' + (parsedDate.getMonth() + 1)).slice(-2) + '-' +
                          ('0' + parsedDate.getDate()).slice(-2);

    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "meal_planner:select_recipe" %}';

    var csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = '{{ csrf_token }}';
    form.appendChild(csrfToken);

    var recipeInput = document.createElement('input');
    recipeInput.type = 'hidden';
    recipeInput.name = 'recipe_id';
    recipeInput.value = recipeId;
    form.appendChild(recipeInput);

    var dateInput = document.createElement('input');
    dateInput.type = 'hidden';
    dateInput.name = 'date';
    dateInput.value = formattedDate;
    form.appendChild(dateInput);

    var mealTypeInput = document.createElement('input');
    mealTypeInput.type = 'hidden';
    mealTypeInput.name = 'meal_type';
    mealTypeInput.value = mealType;
    form.appendChild(mealTypeInput);

    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
